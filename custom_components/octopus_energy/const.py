import voluptuous as vol
import homeassistant.helpers.config_validation as cv
from homeassistant.helpers import selector

DOMAIN = "octopus_energy"
INTEGRATION_VERSION = "15.0.2"

REFRESH_RATE_IN_MINUTES_ACCOUNT = 60
REFRESH_RATE_IN_MINUTES_INTELLIGENT = 3
REFRESH_RATE_IN_MINUTES_RATES = 15
REFRESH_RATE_IN_MINUTES_PREVIOUS_CONSUMPTION = 30
REFRESH_RATE_IN_MINUTES_STANDING_CHARGE = 60
REFRESH_RATE_IN_MINUTES_OCTOPLUS_SAVING_SESSIONS = 15
REFRESH_RATE_IN_MINUTES_OCTOPLUS_FREE_ELECTRICITY_SESSIONS = 90
REFRESH_RATE_IN_MINUTES_OCTOPLUS_SAVING_SESSION_TARGET = 60
REFRESH_RATE_IN_MINUTES_OCTOPLUS_WHEEL_OF_FORTUNE = 60
REFRESH_RATE_IN_MINUTES_OCTOPLUS_POINTS = 60
REFRESH_RATE_IN_MINUTES_GREENNESS_FORECAST = 180
REFRESH_RATE_IN_MINUTES_HOME_PRO_CONSUMPTION = 0.17
REFRESH_RATE_IN_MINUTES_HEAT_PUMP = 1

CONFIG_VERSION = 5

CONFIG_KIND = "kind"
CONFIG_KIND_ACCOUNT = "account"
CONFIG_KIND_TARGET_RATE = "target_rate"
CONFIG_KIND_ROLLING_TARGET_RATE = "rolling_target_rate"
CONFIG_KIND_COST_TRACKER = "cost_tracker"
CONFIG_KIND_TARIFF_COMPARISON = "tariff_comparison"

CONFIG_MAIN_OLD_API_KEY = "Api key"
CONFIG_MAIN_OLD_ACCOUNT_ID = "Account Id"

CONFIG_MAIN_API_KEY = "api_key"
CONFIG_ACCOUNT_ID = "account_id"
CONFIG_MAIN_SUPPORTS_LIVE_CONSUMPTION = "supports_live_consumption"
CONFIG_MAIN_LIVE_ELECTRICITY_CONSUMPTION_REFRESH_IN_MINUTES = "live_electricity_consumption_refresh_in_minutes"
CONFIG_MAIN_LIVE_GAS_CONSUMPTION_REFRESH_IN_MINUTES = "live_gas_consumption_refresh_in_minutes"
CONFIG_MAIN_CALORIFIC_VALUE = "calorific_value"
CONFIG_MAIN_ELECTRICITY_PRICE_CAP = "electricity_price_cap"
CONFIG_MAIN_GAS_PRICE_CAP = "gas_price_cap"
CONFIG_MAIN_HOME_PRO_ADDRESS = "home_pro_address"
CONFIG_MAIN_HOME_PRO_API_KEY = "home_pro_api_key"
CONFIG_MAIN_FAVOUR_DIRECT_DEBIT_RATES = "favour_direct_debit_rates"
CONFIG_MAIN_INTELLIGENT_MANUAL_DISPATCHES = "intelligent_manual_dispatches"
CONFIG_MAIN_AUTO_DISCOVER_COST_TRACKERS = "auto_discover_cost_trackers"
CONFIG_MAIN_INTELLIGENT_RATE_MODE = "intelligent_rate_mode"
CONFIG_MAIN_INTELLIGENT_RATE_MODE_PENDING_AND_STARTED_DISPATCHES = "pending_and_started_dispatches"
CONFIG_MAIN_INTELLIGENT_RATE_MODE_STARTED_DISPATCHES_ONLY = "started_dispatches_only"

CONFIG_DEFAULT_LIVE_ELECTRICITY_CONSUMPTION_REFRESH_IN_MINUTES = 1
CONFIG_DEFAULT_LIVE_GAS_CONSUMPTION_REFRESH_IN_MINUTES = 2

CONFIG_TARGET_OLD_NAME = "Name"
CONFIG_TARGET_OLD_HOURS = "Hours"
CONFIG_TARGET_OLD_TYPE = "Type"
CONFIG_TARGET_OLD_START_TIME = "Start time"
CONFIG_TARGET_OLD_END_TIME = "End time"
CONFIG_TARGET_OLD_MPAN = "MPAN"

CONFIG_TARGET_NAME = "name"
CONFIG_TARGET_HOURS = "hours"
CONFIG_TARGET_HOURS_MODE = "hours_mode"
CONFIG_TARGET_HOURS_MODE_EXACT = "exact_hours"
CONFIG_TARGET_HOURS_MODE_MINIMUM = "minimum_hours"
CONFIG_TARGET_HOURS_MODE_MAXIMUM = "maximum_hours"
CONFIG_TARGET_TYPE = "type"
CONFIG_TARGET_TYPE_CONTINUOUS = "Continuous"
CONFIG_TARGET_TYPE_INTERMITTENT = "Intermittent"
CONFIG_TARGET_START_TIME = "start_time"
CONFIG_TARGET_END_TIME = "end_time"
CONFIG_TARGET_MPAN = "mpan"
CONFIG_TARGET_OFFSET = "offset"
CONFIG_TARGET_ROLLING_TARGET = "rolling_target"
CONFIG_TARGET_LAST_RATES = "last_rates"
CONFIG_TARGET_INVERT_TARGET_RATES = "target_invert_target_rates"
CONFIG_TARGET_MIN_RATE = "minimum_rate"
CONFIG_TARGET_MAX_RATE = "maximum_rate"
CONFIG_TARGET_WEIGHTING = "weighting"
CONFIG_TARGET_FREE_ELECTRICITY_WEIGHTING = "free_electricity_weighting"
CONFIG_TARGET_TARGET_TIMES_EVALUATION_MODE = "target_times_evaluation_mode"
CONFIG_TARGET_TARGET_TIMES_EVALUATION_MODE_ALL_IN_PAST = "all_target_times_in_past"
CONFIG_TARGET_TARGET_TIMES_EVALUATION_MODE_ALL_IN_FUTURE_OR_PAST = "all_target_times_in_future_or_past"
CONFIG_TARGET_TARGET_TIMES_EVALUATION_MODE_ALWAYS = "always"

CONFIG_ROLLING_TARGET_HOURS_LOOK_AHEAD = "look_ahead_hours"

CONFIG_TARGET_KEYS = [
  CONFIG_TARGET_NAME,
  CONFIG_TARGET_HOURS,
  CONFIG_TARGET_TYPE,
  CONFIG_TARGET_START_TIME,
  CONFIG_TARGET_END_TIME,
  CONFIG_TARGET_MPAN,
  CONFIG_TARGET_OFFSET,
  CONFIG_TARGET_ROLLING_TARGET,
  CONFIG_TARGET_LAST_RATES,
  CONFIG_TARGET_INVERT_TARGET_RATES,
  CONFIG_TARGET_MIN_RATE,
  CONFIG_TARGET_MAX_RATE,
  CONFIG_TARGET_WEIGHTING,
  CONFIG_TARGET_FREE_ELECTRICITY_WEIGHTING,
  CONFIG_ROLLING_TARGET_HOURS_LOOK_AHEAD,
  CONFIG_TARGET_TARGET_TIMES_EVALUATION_MODE
]

CONFIG_COST_TRACKER_NAME = "name"
CONFIG_COST_TRACKER_MPAN = "mpan"
CONFIG_COST_TRACKER_TARGET_ENTITY_ID = "target_entity_id"
CONFIG_COST_TRACKER_ENTITY_ACCUMULATIVE_VALUE = "entity_accumulative_value"
CONFIG_COST_TRACKER_WEEKDAY_RESET = "weekday_reset"
CONFIG_COST_TRACKER_MONTH_DAY_RESET = "month_day_reset"
CONFIG_COST_TRACKER_MANUAL_RESET = "manual_reset"
CONFIG_COST_TRACKER_DISCOVERY_NAME = "discovery_name"
CONFIG_COST_TRACKER_DISCOVERY_ACCOUNT_ID = "account_id"

CONFIG_TARIFF_COMPARISON_NAME = "name"
CONFIG_TARIFF_COMPARISON_MPAN_MPRN = "mpan_mprn"
CONFIG_TARIFF_COMPARISON_PRODUCT_CODE = "product_code"
CONFIG_TARIFF_COMPARISON_TARIFF_CODE = "tariff_code"

DATA_CONFIG = "CONFIG"
DATA_ELECTRICITY_RATES_COORDINATOR_KEY = "ELECTRICITY_RATES_COORDINATOR_{}_{}"
DATA_ELECTRICITY_RATES_KEY = "ELECTRICITY_RATES_{}_{}"
DATA_CLIENT = "CLIENT"
DATA_HOME_PRO_CLIENT = "HOME_PRO_CLIENT"
DATA_GAS_TARIFF_CODE = "GAS_TARIFF_CODE"
DATA_ACCOUNT = "ACCOUNT"
DATA_ACCOUNT_COORDINATOR = "ACCOUNT_COORDINATOR"
DATA_SAVING_SESSIONS = "SAVING_SESSIONS"
DATA_SAVING_SESSIONS_COORDINATOR = "SAVING_SESSIONS_COORDINATOR"
DATA_KNOWN_TARIFF = "KNOWN_TARIFF"
DATA_GAS_RATES_COORDINATOR_KEY = "DATA_GAS_RATES_COORDINATOR_{}_{}"
DATA_GAS_RATES_KEY = "GAS_RATES_{}_{}"
DATA_INTELLIGENT_DEVICE = "INTELLIGENT_DEVICE"
DATA_INTELLIGENT_MPAN = "INTELLIGENT_MPAN"
DATA_INTELLIGENT_SERIAL_NUMBER = "INTELLIGENT_SERIAL_NUMBER"
DATA_INTELLIGENT_DISPATCHES = "INTELLIGENT_DISPATCHES"
DATA_INTELLIGENT_DISPATCHES_COORDINATOR = "INTELLIGENT_DISPATCHES_COORDINATOR"
DATA_INTELLIGENT_SETTINGS = "INTELLIGENT_SETTINGS"
DATA_INTELLIGENT_SETTINGS_COORDINATOR = "INTELLIGENT_SETTINGS_COORDINATOR"
DATA_ELECTRICITY_STANDING_CHARGE_KEY = "ELECTRICITY_STANDING_CHARGES_{}_{}"
DATA_GAS_STANDING_CHARGE_KEY = "GAS_STANDING_CHARGES_{}_{}"
DATA_WHEEL_OF_FORTUNE_SPINS = "WHEEL_OF_FORTUNE_SPINS"
DATA_CURRENT_CONSUMPTION_KEY = "CURRENT_CONSUMPTION_{}"
DATA_GREENNESS_FORECAST_COORDINATOR = "GREENNESS_FORECAST_COORDINATOR"
DATA_GREENNESS_FORECAST = "GREENNESS_FORECAST"
DATA_PREVIOUS_CONSUMPTION_COORDINATOR_KEY = "DATA_PREVIOUS_CONSUMPTION_AND_COST_COORDINATOR_{}_{}"
DATA_HOME_PRO_CURRENT_CONSUMPTION_KEY = "HOME_PRO_CURRENT_CONSUMPTION_{}"
DATA_FREE_ELECTRICITY_SESSIONS = "FREE_ELECTRICITY_SESSIONS"
DATA_FREE_ELECTRICITY_SESSIONS_COORDINATOR = "FREE_ELECTRICITY_SESSIONS_COORDINATOR"
DATA_CUSTOM_RATE_WEIGHTINGS_KEY = "DATA_CUSTOM_RATE_WEIGHTINGS_{}"
DATA_DISCOVERY_MANAGER = "DATA_DISCOVERY_MANAGER"

DATA_HEAT_PUMP_CONFIGURATION_AND_STATUS_KEY = "HEAT_PUMP_CONFIGURATION_AND_STATUS_{}"
DATA_HEAT_PUMP_CONFIGURATION_AND_STATUS_COORDINATOR = "HEAT_PUMP_CONFIGURATION_AND_STATUS_COORDINATOR_{}"

DATA_SAVING_SESSIONS_FORCE_UPDATE = "SAVING_SESSIONS_FORCE_UPDATE"

STORAGE_ELECTRICITY_TARIFF_OVERRIDE_NAME = "octopus_energy.{}-{}-tariff-override.json"
STORAGE_TARIFF_CACHE_NAME = "octopus_energy.tariff-{}.json"
STORAGE_METER_DEBUG_OVERRIDE_NAME = "octopus_energy.{}-{}-override.json"
STORAGE_ACCOUNT_DEBUG_OVERRIDE_NAME = "octopus_energy.{}-override.json"

INTELLIGENT_SOURCE_SMART_CHARGE = "smart-charge"
INTELLIGENT_SOURCE_BUMP_CHARGE = "bump-charge"

REGEX_HOURS = "^[0-9]+(\\.[0-9]+)*$"
REGEX_TIME = "^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$"
REGEX_ENTITY_NAME = "^[a-z0-9_]+$"
# According to https://www.guylipman.com/octopus/api_guide.html#s1b, this part should indicate the types of tariff
# However it looks like there are some tariffs that don't fit this mold
REGEX_TARIFF_PARTS = "^((?P<energy>[A-Z])-(?P<rate>[0-9A-Z]+)-)?(?P<product_code>[A-Z0-9-]+)-(?P<region>[A-Z])$"
REGEX_OFFSET_PARTS = "^(-)?([0-1]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$"
REGEX_DATE = "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
REGEX_PRICE = "^(-)?[0-9]+(\\.[0-9]+)*$"

REGEX_WEIGHTING_NUMBERS = "([0-9]+\\.?[0-9]*(,[0-9]+\\.?[0-9]*+)*)"
REGEX_WEIGHTING_START = "(\\*(,[0-9]+\\.?[0-9]*+)+)"
REGEX_WEIGHTING_MIDDLE = "([0-9]+\\.?[0-9]*(,[0-9]+\\.?[0-9]*+)*(,\\*)(,[0-9]+\\.?[0-9]*+)+)"
REGEX_WEIGHTING_END = "([0-9]+\\.?[0-9]*(,[0-9]+\\.?[0-9]*+)*(,\\*))"
REGEX_WEIGHTING = f"^({REGEX_WEIGHTING_NUMBERS}|{REGEX_WEIGHTING_START}|{REGEX_WEIGHTING_MIDDLE}|{REGEX_WEIGHTING_END})$"

DEFAULT_CALORIFIC_VALUE = 40.0
DEFAULT_BOOST_TEMPERATURE_WATER = 50
DEFAULT_BOOST_TEMPERATURE_HEAT = 30

DATA_SCHEMA_ACCOUNT = vol.Schema({
  vol.Required(CONFIG_ACCOUNT_ID): str,
  vol.Required(CONFIG_MAIN_API_KEY): str,
  vol.Required(CONFIG_MAIN_CALORIFIC_VALUE, default=DEFAULT_CALORIFIC_VALUE): cv.positive_float,
  vol.Required(CONFIG_MAIN_SUPPORTS_LIVE_CONSUMPTION): bool,
  vol.Optional(CONFIG_MAIN_HOME_PRO_ADDRESS): str,
  vol.Optional(CONFIG_MAIN_HOME_PRO_API_KEY): str,
  vol.Required(CONFIG_MAIN_LIVE_ELECTRICITY_CONSUMPTION_REFRESH_IN_MINUTES, default=CONFIG_DEFAULT_LIVE_ELECTRICITY_CONSUMPTION_REFRESH_IN_MINUTES): cv.positive_int,
  vol.Required(CONFIG_MAIN_LIVE_GAS_CONSUMPTION_REFRESH_IN_MINUTES, default=CONFIG_DEFAULT_LIVE_ELECTRICITY_CONSUMPTION_REFRESH_IN_MINUTES): cv.positive_int,
  vol.Optional(CONFIG_MAIN_ELECTRICITY_PRICE_CAP): cv.positive_float,
  vol.Optional(CONFIG_MAIN_GAS_PRICE_CAP): cv.positive_float,
  vol.Required(CONFIG_MAIN_FAVOUR_DIRECT_DEBIT_RATES): bool,
  vol.Required(CONFIG_MAIN_INTELLIGENT_MANUAL_DISPATCHES): bool,
  vol.Required(CONFIG_MAIN_INTELLIGENT_RATE_MODE): selector.SelectSelector(
    selector.SelectSelectorConfig(
        options=[
          selector.SelectOptionDict(value=CONFIG_MAIN_INTELLIGENT_RATE_MODE_PENDING_AND_STARTED_DISPATCHES, label="Planned and started dispatches will turn into off peak rates"),
          selector.SelectOptionDict(value=CONFIG_MAIN_INTELLIGENT_RATE_MODE_STARTED_DISPATCHES_ONLY, label="Only started dispatches will turn into off peak rates"),
        ],
        mode=selector.SelectSelectorMode.DROPDOWN,
    )
  ),
  vol.Required(CONFIG_MAIN_AUTO_DISCOVER_COST_TRACKERS): bool,
})

EVENT_ELECTRICITY_PREVIOUS_DAY_RATES = "octopus_energy_electricity_previous_day_rates"
EVENT_ELECTRICITY_CURRENT_DAY_RATES = "octopus_energy_electricity_current_day_rates"
EVENT_ELECTRICITY_NEXT_DAY_RATES = "octopus_energy_electricity_next_day_rates"
EVENT_ELECTRICITY_PREVIOUS_CONSUMPTION_RATES = "octopus_energy_electricity_previous_consumption_rates"
EVENT_ELECTRICITY_PREVIOUS_CONSUMPTION_TARIFF_COMPARISON_RATES = "octopus_energy_elec_previous_consumption_tariff_comparison_rates"

EVENT_GAS_PREVIOUS_DAY_RATES = "octopus_energy_gas_previous_day_rates"
EVENT_GAS_CURRENT_DAY_RATES = "octopus_energy_gas_current_day_rates"
EVENT_GAS_NEXT_DAY_RATES = "octopus_energy_gas_next_day_rates"
EVENT_GAS_PREVIOUS_CONSUMPTION_RATES = "octopus_energy_gas_previous_consumption_rates"
EVENT_GAS_PREVIOUS_CONSUMPTION_TARIFF_COMPARISON_RATES = "octopus_energy_gas_previous_consumption_tariff_comparison_rates"

EVENT_NEW_SAVING_SESSION = "octopus_energy_new_octoplus_saving_session"
EVENT_ALL_SAVING_SESSIONS = "octopus_energy_all_octoplus_saving_sessions"

EVENT_NEW_FREE_ELECTRICITY_SESSION = "octopus_energy_new_octoplus_free_electricity_session"
EVENT_ALL_FREE_ELECTRICITY_SESSIONS = "octopus_energy_all_octoplus_free_electricity_sessions"

REPAIR_UNIQUE_RATES_CHANGED_KEY = "electricity_unique_rates_updated_{}"
REPAIR_INVALID_API_KEY = "invalid_api_key_{}"
REPAIR_ACCOUNT_NOT_FOUND = "account_not_found_{}"
REPAIR_UNKNOWN_INTELLIGENT_PROVIDER = "unknown_intelligent_provider_{}"
REPAIR_NO_ACTIVE_TARIFF = "no_active_tariff_{}_{}"
REPAIR_TARGET_RATE_REMOVAL_PROPOSAL = "target_rate_removal_proposal"

# During BST, two records are returned before the rest of the data is available
MINIMUM_CONSUMPTION_DATA_LENGTH = 3

COORDINATOR_REFRESH_IN_SECONDS = 60
HOME_PRO_COORDINATOR_REFRESH_IN_SECONDS = 10
DISCOVERY_REFRESH_IN_HOURS = 2